@model dynamic
@{
    var dataSourceContext = new Kooboo.CMS.Sites.DataSource.DataSourceContext(Site.Current, null);
    var dataSources = ServiceFactory.GetService<DataSourceSettingManager>().All(Site.Current, "")
        .Select(it => new
        {
            Name = it.DataName,
            IsEnumerable = it.DataSource.IsEnumerable(),
            Definitions = it.DataSource.GetDefinitions(dataSourceContext).Keys
        });

    var dataSourceJson = Newtonsoft.Json.JsonConvert.SerializeObject(dataSources);

    var pages = ServiceFactory.PageManager.AllPagesFlattened(Site.Current)
        .Select(it => it.LastVersion().AsActual())
        .Where(it => it != null)
        .Select(it => new
        {
            it.FullName,
            Parameters = it.Route.GetRouteParameters()
        });
    var pagesJosn = Newtonsoft.Json.JsonConvert.SerializeObject(pages);
}
<script>


    var meta = {
            dataSourceMeta : @Html.Raw(dataSourceJson),
            pages: @Html.Raw(pagesJosn)
        };
    
</script>
<script>
    var __datasrc__ = [];
    var __pages__ = [];
    _.each(meta.pages,function(page){
        var params = [];
        _.each(page.Parameters,function(param){
            params.push({
                name:param,
                value:"",
            });
        });
        __pages__.push({
            name:page.FullName,
            external: false,
            params:params
        });
    });
   
    var externalLink = "@("External link".Localize())";

    var __msgs__ = {
        'can_not_be_label': 'Can not convert this element into a label!',
        'remove_data_binding_confrim': 'Are you sure to delete the data binding?',
        'save_binding_success': 'successed!',
        'url_invalid': 'url invalid!'
    };

    var __urls__ = {};

</script>
<script src="~/Areas/Sites/Scripts/talEditor/ctrl-panel.js"></script>
<script>
    $(function () {
        var textArea = $('#Body');
        textArea.codeMirror();
        var codeMirrorAPI = textArea.data("codeMirror");
        codeMirrorAPI.on('change', function (e) {
            if (e && e.historySize().undo > 0) {
                window.leaveConfirm.stop();
            } else {
                window.leaveConfirm.pass();
            }
        });
        $('#tab_sourceCode').on('show',function(){
            codeMirrorAPI.refresh();
            //setTimeout(function(){codeMirrorAPI.refresh();},10);
        });
        window.ajaxFormParam = {
            beforeSerialize: function ($form, options) {
                if(__ctx__.isPreview){
                    textArea.val(__ctx__.editorWrapper.html());
                }else{
                    textArea.val(codeMirrorAPI.getValue());
                }
            }
        };

        $('.tabs').koobooTab();
        $("#tab_dataBinding").applyBindings(new PanelModel());
        $("#span-tag-text-container").on('click','a', function (e) {
            e.preventDefault();
        });
        $('div.block').on('click','.title', function () {
            $(this).parent('.block').toggleClass('active');
        });
        $("input[name=ConvertedType],input[name=ImageType]").on('click', function () {
            $('label[for='+$(this).attr('id')+']').click();
        });
        $("#label-textarea").autosize();
        $("#tab-data-source").click();

        //switch design mode
        __conf__.editorPosRight = $("#div-editor-container").css("right");
        $("#design-view-tags").on('click', 'a', function () {
            var wrapper = __ctx__.editorWrapper;
            if ($(this).attr('type') == 'preview') {
                wrapper.html(codeMirrorAPI.getValue());
                __ctx__.initEditorHandler();
                __ctx__.isPreview = true;
                __ctx__.highlighter.hide();
                __ctx__.highlighterCopy.hide();
                $("#tab-data-source").click();
                $("#div-editor-container").css({'right': __conf__.editorPosRight});
                $("#div-panel-container").show();
                $("div.layout-selector").show();
            } else {
                codeMirrorAPI.setValue(wrapper.html());
                __ctx__.isPreview = false;
                $("#tab-data-binding").click();
                $("#div-editor-container").css({'right':0});
                $("#div-panel-container").hide();
                $("div.layout-selector").hide();
            }
        });

    });
</script>
